<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Al-Qur'an</title>
  <!-- Tambahkan Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Gaya dasar */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #F4F7F6;
      color: #2C3E50;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h1, h2 {
      color: #16A085;
      text-align: center;
    }
    /* Tampilan daftar surah */
    #surahListView {
      margin-bottom: 20px;
    }
    /* Header di halaman depan: tombol global bookmark */
    #frontHeader {
      text-align: center;
      margin-bottom: 15px;
    }
    #frontHeader button {
      background: #16A085;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 1em;
    }
    #frontHeader button:hover {
      background: #138f75;
    }
    #surahListView input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #surahListView ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    #surahListView li {
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
      border-left: 4px solid #16A085;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
    }
    #surahListView li:hover {
      background: #d1e7e4;
      transform: translateX(5px);
    }
    /* Tampilan detail surah (ayat) */
    #surahDetailView {
      display: none;
    }
    #detailHeader {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }
    #detailHeader button {
      background: #16A085;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 1em;
    }
    #detailHeader button:hover {
      background: #138f75;
    }
    .ayat {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #16A085;
      border-radius: 4px;
    }
    .ayat p {
      margin: 8px 0;
      line-height: 1.6;
    }
    .arabic-number-badge {
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      background: linear-gradient(135deg, #16A085, #1abc9c);
      border: 2px solid #fff;
      border-radius: 50%;
      text-align: center;
      margin-left: 10px;
      font-weight: bold;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      font-size: 0.75em;
    }
    .arabic {
      font-size: 1.2em;
      text-align: right;
      direction: rtl;
    }
    .bismillah {
      text-align: center;
      font-size: 1.8em;
      margin: 20px auto;
      padding: 10px 20px;
      max-width: 90%;
      background: #fdf6e3;
      border: 2px solid #16A085;
      border-radius: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.16);
      direction: rtl;
      font-weight: bold;
      letter-spacing: 1px;
      color: #16A085;
      font-family: 'Amiri', serif;
    }
    .icons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .icons button {
      background: #16A085;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 1em;
    }
    .icons button:hover {
      background: #138f75;
    }
    .play-all-btn {
      background: #16A085;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 15px;
      transition: background 0.3s;
      font-size: 1em;
    }
    .play-all-btn:hover {
      background: #138f75;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tampilan Daftar Surat -->
    <div id="surahListView">
      <h1>Daftar Surat</h1>
      <!-- Tombol Global Bookmark untuk halaman depan -->
      <div id="frontHeader">
        <button id="globalBookmarkFrontBtn">No Bookmark</button>
      </div>
      <input type="text" id="searchSurah" placeholder="Cari Surah..." />
      <ul id="suratList"></ul>
    </div>
    <!-- Tampilan Detail Surah (Ayat) -->
    <div id="surahDetailView">
      <div id="detailHeader">
        <button id="backBtn">&larr; Kembali ke Daftar Surat</button>
        <button id="goToBookmarkBtn">No Bookmark</button>
        <button id="prevSurahBtn">Surah Sebelumnya</button>
        <button id="nextSurahBtn">Surah Berikutnya</button>
      </div>
      <div id="ayatContainer">
        <p>Pilih salah satu surat untuk menampilkan ayatnya.</p>
      </div>
    </div>
  </div>

  <script>
    // Variabel global
    let allSurat = [];
    let currentSurahIndex = -1;
    let isPlayingAllAudio = false;
    let currentAudio = null;
    let currentIndividualAudio = null;
    let currentIndividualKey = null;

    // Fungsi konversi nomor ke angka Arab
    function toArabicNumerals(num) {
      const arabicDigits = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
      return num.toString().split('').map(digit => arabicDigits[digit]).join('');
    }

    function stopAllAudio() {
      isPlayingAllAudio = false;
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
      }
    }

    function stopIndividualAudio() {
      if (currentIndividualAudio) {
        currentIndividualAudio.pause();
        currentIndividualAudio.currentTime = 0;
        document.querySelectorAll('button[title="Putar Audio Individual"]').forEach(btn => {
          if (btn.getAttribute('data-key') === currentIndividualKey) {
            btn.innerHTML = '<i class="fa-solid fa-volume-up"></i>';
          }
        });
        currentIndividualAudio = null;
        currentIndividualKey = null;
      }
    }

    function playSequentialAudio(urls, index = 0) {
      if (!isPlayingAllAudio) return;
      if (index >= urls.length) {
        isPlayingAllAudio = false;
        return;
      }
      currentAudio = new Audio(urls[index]);
      currentAudio.play();
      currentAudio.addEventListener('ended', function() {
        if (isPlayingAllAudio) {
          playSequentialAudio(urls, index + 1);
        }
      });
    }

    function playAudioIndividual(url, btn, key) {
      stopAllAudio();
      if (currentIndividualKey === key && currentIndividualAudio) {
        stopIndividualAudio();
        btn.innerHTML = '<i class="fa-solid fa-volume-up"></i>';
      } else {
        stopIndividualAudio();
        currentIndividualAudio = new Audio(url);
        currentIndividualKey = key;
        currentIndividualAudio.play();
        btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
        currentIndividualAudio.addEventListener('ended', function() {
          btn.innerHTML = '<i class="fa-solid fa-volume-up"></i>';
          currentIndividualAudio = null;
          currentIndividualKey = null;
        });
      }
    }

    function copyText(text) {
      navigator.clipboard.writeText(text)
        .then(() => { alert("Teks berhasil disalin!"); })
        .catch(err => { console.error("Gagal menyalin teks: ", err); });
    }

    function toggleFavorite(key, btn) {
      let favs = JSON.parse(localStorage.getItem('favoriteAyats') || '[]');
      if (favs.includes(key)) {
        favs = favs.filter(item => item !== key);
        btn.innerHTML = '<i class="fa-regular fa-heart"></i>';
      } else {
        favs.push(key);
        btn.innerHTML = '<i class="fa-solid fa-heart"></i>';
      }
      localStorage.setItem('favoriteAyats', JSON.stringify(favs));
    }

    function setBookmark(key, btn) {
      const currentBookmark = localStorage.getItem('lastReadAyat');
      if (currentBookmark === key) {
        localStorage.removeItem('lastReadAyat');
        localStorage.removeItem('lastReadSurah');
        btn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
      } else {
        localStorage.setItem('lastReadAyat', key);
        const surahName = btn.getAttribute('data-surah');
        localStorage.setItem('lastReadSurah', surahName);
        btn.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
      }
      updateGlobalBookmarkBoth();
    }

    // Fungsi untuk mengupdate tombol global bookmark di kedua halaman
    function updateGlobalBookmarkBoth() {
      const bookmarkKey = localStorage.getItem('lastReadAyat');
      const surahName = localStorage.getItem('lastReadSurah');

      // Update tombol di halaman depan
      const frontBtn = document.getElementById('globalBookmarkFrontBtn');
      if (frontBtn) {
        if (bookmarkKey && surahName) {
          frontBtn.disabled = false;
          frontBtn.textContent = 'Go to Bookmark: ' + surahName;
        } else {
          frontBtn.disabled = true;
          frontBtn.textContent = 'No Bookmark';
        }
      }
      // Update tombol di halaman detail
      const detailBtn = document.getElementById('goToBookmarkBtn');
      if (detailBtn) {
        if (bookmarkKey && surahName) {
          detailBtn.disabled = false;
          detailBtn.textContent = 'Go to Bookmark: ' + surahName;
        } else {
          detailBtn.disabled = true;
          detailBtn.textContent = 'No Bookmark';
        }
      }
    }

    // Event listener untuk tombol global bookmark di halaman depan
    document.getElementById('globalBookmarkFrontBtn').addEventListener('click', function() {
      goToBookmark();
    });

    // Event listener untuk tombol global bookmark di halaman detail
    document.getElementById('goToBookmarkBtn').addEventListener('click', function() {
      goToBookmark();
    });

    // Fungsi untuk menavigasi ke bookmark (digunakan oleh kedua tombol global)
    function goToBookmark() {
      const bookmarkKey = localStorage.getItem('lastReadAyat');
      if (!bookmarkKey) {
        alert("Tidak ada bookmark.");
        return;
      }
      let targetElement = document.getElementById(bookmarkKey);
      if (targetElement) {
        targetElement.scrollIntoView({ behavior: "smooth", block: "center" });
      } else {
        // Jika elemen bookmark tidak ditemukan, cari surah terkait dan muat surah tersebut.
        const parts = bookmarkKey.split('_');
        const targetSurahNumber = Number(parts[0]);
        const targetSurah = allSurat.find(s => Number(s.nomor) === targetSurahNumber);
        if (targetSurah) {
          loadSurah(targetSurah, allSurat.indexOf(targetSurah));
          // Tunggu agar ayat termuat, lalu scroll ke bookmark
          setTimeout(() => {
            let newTarget = document.getElementById(bookmarkKey);
            if (newTarget) {
              newTarget.scrollIntoView({ behavior: "smooth", block: "center" });
            } else {
              alert("Bookmark tidak ditemukan setelah memuat surah.");
            }
          }, 1000);
        } else {
          alert("Surah untuk bookmark tidak ditemukan.");
        }
      }
    }

    // Fungsi untuk memuat dan menampilkan detail surah (ayat)
    function loadSurah(surah, index) {
      stopAllAudio();
      stopIndividualAudio();
      currentSurahIndex = index;
      // Sembunyikan tampilan daftar surah dan tampilkan detail surah
      document.getElementById('surahListView').style.display = 'none';
      document.getElementById('surahDetailView').style.display = 'block';

      const ayatContainer = document.getElementById('ayatContainer');
      ayatContainer.innerHTML = `<h2>${surah.namaLatin} - ${surah.arti}</h2>`;
      if (Number(surah.nomor) !== 1 && Number(surah.nomor) !== 9) {
        ayatContainer.innerHTML += `<p class="bismillah">بِسْمِ اللهِ الرَّحْمٰنِ الرَّحِيْمِ</p>`;
      }
      const audioUrls = [];
      fetch(`https://equran.id/api/v2/surat/${surah.nomor}`)
        .then(response => response.json())
        .then(detailData => {
          if (detailData.data && detailData.data.ayat) {
            detailData.data.ayat.forEach(ayat => {
              if (ayat.audio && ayat.audio["01"]) {
                audioUrls.push(ayat.audio["01"]);
              }
            });
            if (audioUrls.length > 0) {
              const playAllBtn = document.createElement('button');
              playAllBtn.classList.add('play-all-btn');
              playAllBtn.innerHTML = '<i class="fa-solid fa-play"></i> Play All Audio';
              playAllBtn.addEventListener('click', function() {
                if (isPlayingAllAudio) {
                  stopAllAudio();
                  playAllBtn.innerHTML = '<i class="fa-solid fa-play"></i> Play All Audio';
                } else {
                  stopIndividualAudio();
                  isPlayingAllAudio = true;
                  playAllBtn.innerHTML = '<i class="fa-solid fa-stop"></i> Stop Audio';
                  playSequentialAudio(audioUrls);
                }
              });
              ayatContainer.appendChild(playAllBtn);
            }
            detailData.data.ayat.forEach(ayat => {
              const ayatDiv = document.createElement('div');
              ayatDiv.classList.add('ayat');
              const uniqueKey = surah.nomor + '_' + ayat.nomorAyat;
              ayatDiv.id = uniqueKey;
              const favs = JSON.parse(localStorage.getItem('favoriteAyats') || '[]');
              const isFav = favs.includes(uniqueKey);
              const bookmarked = localStorage.getItem('lastReadAyat');
              const isBookmarked = (bookmarked === uniqueKey);
              ayatDiv.innerHTML = `
                <p class="arabic">
                  ${ayat.teksArab}
                  <span class="arabic-number-badge">${toArabicNumerals(ayat.nomorAyat)}</span>
                </p>
                <p><em>${ayat.teksLatin}</em></p>
                ${ayat.teksIndonesia ? `<p>${ayat.teksIndonesia}</p>` : ''}
                <div class="icons">
                  <button title="Putar Audio Individual" data-key="${uniqueKey}" onclick="playAudioIndividual('${ayat.audio["01"]}', this, '${uniqueKey}')">
                    <i class="fa-solid fa-volume-up"></i>
                  </button>
                  <button title="Salin Teks" onclick="copyText('${(ayat.teksArab + ' ' + ayat.teksLatin + (ayat.teksIndonesia ? ' ' + ayat.teksIndonesia : '')).replace(/'/g, '\\\'')}')">
                    <i class="fa-solid fa-copy"></i>
                  </button>
                  <button title="Favorite" data-key="${uniqueKey}" onclick="toggleFavorite('${uniqueKey}', this)">
                    ${isFav ? '<i class="fa-solid fa-heart"></i>' : '<i class="fa-regular fa-heart"></i>'}
                  </button>
                  <button title="Bookmark (terakhir dibaca)" data-key="${uniqueKey}" data-surah="${surah.namaLatin}" onclick="setBookmark('${uniqueKey}', this)">
                    ${isBookmarked ? '<i class="fa-solid fa-bookmark"></i>' : '<i class="fa-regular fa-bookmark"></i>'}
                  </button>
                </div>
              `;
              ayatContainer.appendChild(ayatDiv);
            });
            updateGlobalBookmarkBoth();
          } else {
            ayatContainer.innerHTML += `<p>Data ayat tidak tersedia.</p>`;
          }
        })
        .catch(error => {
          console.error('Error fetching ayat:', error);
          ayatContainer.innerHTML += `<p>Terjadi kesalahan saat mengambil data ayat.</p>`;
        });
    }

    // Render daftar surah (halaman depan)
    function renderSuratList(suratArray) {
      const suratList = document.getElementById('suratList');
      suratList.innerHTML = '';
      suratArray.forEach((surah, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${surah.nomor}. ${surah.namaLatin}</strong> - ${surah.arti}`;
        li.addEventListener('click', () => {
          loadSurah(surah, index);
        });
        suratList.appendChild(li);
      });
    }

    // Ambil data surat dari API
    fetch('https://equran.id/api/v2/surat')
      .then(response => response.json())
      .then(data => {
        allSurat = data.data;
        renderSuratList(allSurat);
        updateGlobalBookmarkBoth();
      })
      .catch(error => console.error('Error fetching data surat:', error));

    document.getElementById('searchSurah').addEventListener('input', function() {
      const query = this.value.toLowerCase();
      const filteredSurat = allSurat.filter(surat =>
        surat.namaLatin.toLowerCase().includes(query) ||
        surat.arti.toLowerCase().includes(query)
      );
      renderSuratList(filteredSurat);
    });

    // Tombol Navigasi: Surah Sebelumnya dan Berikutnya di halaman detail
    document.getElementById('prevSurahBtn').addEventListener('click', function() {
      if (currentSurahIndex > 0) {
        loadSurah(allSurat[currentSurahIndex - 1], currentSurahIndex - 1);
      } else {
        alert("Surah sebelumnya tidak tersedia.");
      }
    });

    document.getElementById('nextSurahBtn').addEventListener('click', function() {
      if (currentSurahIndex < allSurat.length - 1) {
        loadSurah(allSurat[currentSurahIndex + 1], currentSurahIndex + 1);
      } else {
        alert("Surah berikutnya tidak tersedia.");
      }
    });

    // Tombol Kembali ke Daftar Surat (di halaman detail)
    document.getElementById('backBtn').addEventListener('click', function() {
      stopAllAudio();
      stopIndividualAudio();
      document.getElementById('ayatContainer').innerHTML = '<p>Pilih salah satu surat untuk menampilkan ayatnya.</p>';
      document.getElementById('surahListView').style.display = 'block';
      document.getElementById('surahDetailView').style.display = 'none';
      updateGlobalBookmarkBoth();
    });
  </script>
</body>
</html>
